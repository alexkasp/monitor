<%@ Page Title="" Language="C#" MasterPageFile="~/Main.master" AutoEventWireup="true"
    CodeBehind="Malwares.aspx.cs" Inherits="SandBox.WebUi.Pages.Malware.Malwares" %>

<%@ Register TagPrefix="dxwgv" Namespace="DevExpress.Web.ASPxGridView" %>
<asp:Content ID="Content1" ContentPlaceHolderID="MainContent" runat="server">
    <script type="text/javascript">
        function OnAddClick(element) {
            popup_upload.ShowAtElement(element);
        }

        function UpdateUploadButton() {
            btnUpload.SetEnabled(uploader.GetText(0) != "");
        }

        function Uploader_OnUploadStart() {
            btnUpload.SetEnabled(false);
        }
        function Uploader_OnFileUploadComplete(args) {
            alert(args.callbackData);
            popup_upload.Hide();
            UpdateUploadButton();
        }

        function OnDeleteClick(element, key) {
            popup_delete.ShowAtElement(element);
            callbackPanel_delete.PerformCallback(key);
        }

        function OnAcceptDelete() {
            popup_delete.Hide();
        }
    </script>
    <div id="content-top">
        <div id="pagename">
            ВПО</div>
            		    <div id="toolbuttons">
                        <table><tr><td>
                                                <dx:ASPxButton ID="btnDownload" AutoPostBack="False" runat="server" 
                            Text="Загрузить ВПО" CssClass="button" 
                            EnableDefaultAppearance="False" EnableTheming="False" Width="150px">
                            <ClientSideEvents Click="function(s, e) {
	OnAddClick(s.GetMainElement());
}" />
                            <PressedStyle CssClass="buttonHover">
                            </PressedStyle>
                            <HoverStyle CssClass="buttonHover">
                            </HoverStyle>
                            <Border BorderColor="Gainsboro" BorderStyle="Solid" BorderWidth="1px" />
                            <DisabledStyle CssClass="buttonDisable">
                            </DisabledStyle>
                        </dx:ASPxButton> </td></tr></table>

</div>
        <div id="tablenavbuttons">
            <asp:UpdatePanel ID="UpdatePagerPanel" runat="server" UpdateMode="Conditional">
                <ContentTemplate>
                    <dx:ASPxPager ID="gridMalwareViewPager" runat="server" ItemCount="1000" ItemsPerPage="100"
                        OnPageIndexChanged="gridMalwareViewPager_PageIndexChanged" Visible="False" OnPageSizeChanged="gridMalwareViewPager_PageSizeChanged"
                        ShowNumericButtons="False" RenderMode="Lightweight" Theme="SandboxTheme">
                        <Summary AllPagesText="{2} эл." Text="{0} из {1} ({2} эл.)" />
                        <PageSizeItemSettings AllItemText="Все" Caption="" Visible="True">
                        </PageSizeItemSettings>
                    </dx:ASPxPager>
                </ContentTemplate>
            <Triggers>
                <asp:AsyncPostBackTrigger ControlID="gridViewMalware" EventName="DataBinding" />
            </Triggers>
            </asp:UpdatePanel>
        </div>

    </div>
    <div id="content-main">
        <asp:UpdatePanel ID="PopupDeletePanel" runat="server" UpdateMode="Conditional">
            <ContentTemplate>
                <dx:ASPxPopupControl ID="popup_delete" ClientInstanceName="popup_delete" 
                    runat="server" ShowCloseButton="False" PopupHorizontalAlign="OutsideRight"
                    HeaderText="Удаление ВПО:">
                    <ContentCollection>
                        <dx:PopupControlContentControl ID="PopupControlContentControl3" runat="server">
                            <dx:ASPxCallbackPanel ID="callbackPanel_delete" ClientInstanceName="callbackPanel_delete"
                                runat="server" Width="250px" Height="50px" OnCallback="CallbackPanelDeleteCallback"
                                RenderMode="Table">
                                <PanelCollection>
                                    <dx:PanelContent ID="PanelContent2" runat="server">
                                        <asp:Literal ID="deleteText" runat="server" Text=""></asp:Literal>
                                        <dx:ASPxButton ID="btnDelete" runat="server" Text="удалить" AutoPostBack="False"
                                            OnClick="BtnDeleteClick">
                                            <ClientSideEvents Click="OnAcceptDelete" />
                                        </dx:ASPxButton>
                                    </dx:PanelContent>
                                </PanelCollection>
                            </dx:ASPxCallbackPanel>
                        </dx:PopupControlContentControl>
                    </ContentCollection>
                </dx:ASPxPopupControl>
            </ContentTemplate>
        </asp:UpdatePanel>
        <asp:UpdatePanel ID="PopupUploadPanel" runat="server" UpdateMode="Conditional">
            <ContentTemplate>
                <dx:ASPxPopupControl ID="popup_upload" ClientInstanceName="popup_upload" runat="server"
                    AllowDragging="false" AllowResize="false" ShowCloseButton="false" PopupHorizontalAlign="OutsideRight"
                    HeaderText="Загрузка ВПО на сервер:">
                    <ContentCollection>
                        <dx:PopupControlContentControl ID="PopupControlContentControl1" runat="server">
                            <dx:ASPxCallbackPanel ID="callbackPanel_upload" ClientInstanceName="callbackPanel_upload"
                                runat="server" Width="200px" Height="50px" RenderMode="Table">
                                <PanelCollection>
                                    <dx:PanelContent ID="PanelContent" runat="server">
                                        <asp:Literal ID="litText" runat="server" Text="Выберите файл для загрузки:"></asp:Literal>
                                        <dx:ASPxUploadControl ID="UploadControl" ClientInstanceName="uploader" runat="server"
                                            ShowProgressPanel="True" NullText="Нажмите, чтобы выбрать файл..." Size="35"
                                            OnFileUploadComplete="FileUploadComplete">
                                            <ValidationSettings FileDoesNotExistErrorText="Загружаемый файл не существует" GeneralErrorText="Ошибка загрузки файла по причине внешней ошибки"
                                                MaxFileSizeErrorText="Размер файла превышает макимально допустимый размер в {0} байт"
                                                NotAllowedContentTypeErrorText="Тип содержимого запрещён" NotAllowedFileExtensionErrorText="Расширение файла запрещено">
                                            </ValidationSettings>
                                            <ClientSideEvents FileUploadComplete="function(s, e) { Uploader_OnFileUploadComplete(e); }"
                                                FileUploadStart="function(s, e) { Uploader_OnUploadStart(); }"></ClientSideEvents>
                                        </dx:ASPxUploadControl>
                                        <dx:ASPxButton ID="btnUpload" ClientInstanceName="btnUpload" runat="server" OnClick="BtnUploadClick"
                                            Text="загрузить" AutoPostBack="false">
                                            <ClientSideEvents Click="function(s, e) { uploader.Upload(); }" />
                                        </dx:ASPxButton>
                                    </dx:PanelContent>
                                </PanelCollection>
                            </dx:ASPxCallbackPanel>
                        </dx:PopupControlContentControl>
                    </ContentCollection>
                </dx:ASPxPopupControl>
            </ContentTemplate>
        </asp:UpdatePanel>
        <asp:UpdatePanel ID="UpdatePanelMalware" runat="server" UpdateMode="Conditional">
            <ContentTemplate>
                <dx:ASPxGridView ID="gridViewMalware" runat="server" AutoGenerateColumns="False"
                    EnableTheming="True" Theme="SandboxTheme" KeyFieldName="Id" EnableCallBacks="False"
                    ClientInstanceName="gridViewMalware" Width="100%" OnCustomCallback="gridViewMalware_CustomCallback">
                    <ClientSideEvents CustomButtonClick="function(s, e) {
	                                        if (e.buttonID == 'cbDelete') {
                                                if (!confirm('Вы уверены, что хотите удалить ВПО?')) { return;}
                                                gridViewMalware.PerformCallback(e.buttonID+','+ s.GetRowKey(e.visibleIndex));
                                                }
	                                        if (e.buttonID == 'cbEdit') {
                                                document.location.href = '/Pages/Malware/MalwareCard.aspx?mlwrID=' + s.GetRowKey(e.visibleIndex);
                                                }
                                        }" RowClick="function(s, e) {
	                                        document.location.href = '/Pages/Malware/MalwareCard.aspx?mlwrID=' + s.GetRowKey(e.visibleIndex);
                                        }" />
                    <Columns>
                        <dx:GridViewCommandColumn VisibleIndex="0" Visible="False">
                        </dx:GridViewCommandColumn>
                        <dx:GridViewDataTextColumn Caption="Id" FieldName="Id" VisibleIndex="1" Visible="false">
                            <PropertiesTextEdit>
                                <ValidationSettings ErrorText="Неверное значение">
                                    <RegularExpression ErrorText="Ошибка проверки регулярного выражения" />
                                </ValidationSettings>
                            </PropertiesTextEdit>
                        </dx:GridViewDataTextColumn>
                        <dx:GridViewDataColumn Caption="Наименование ВПО" FieldName="Name" 
                            VisibleIndex="1">
                        </dx:GridViewDataColumn>
                        <dx:GridViewDataColumn Caption="Исполняемый файл" FieldName="Path" VisibleIndex="2">
                        </dx:GridViewDataColumn>
                        <dx:GridViewDataColumn Caption="Классификация" FieldName="Class" VisibleIndex="3">
                        </dx:GridViewDataColumn>
                        <dx:GridViewDataColumn Caption="Дополнительно" FieldName="Loaded" VisibleIndex="4">
                        </dx:GridViewDataColumn>
                        <dx:GridViewCommandColumn VisibleIndex="5" ButtonType="Image" Width="50px" Caption="Карточка ВПО">
                            <CustomButtons>
                                <dx:GridViewCommandColumnCustomButton ID="cbEdit">
                                    <Image ToolTip="Редактировать" Url="../../Content/Images/Icons/edit2.png" />
                                </dx:GridViewCommandColumnCustomButton>
                            </CustomButtons>
                            <CellStyle HorizontalAlign="Center">
                            </CellStyle>
                        </dx:GridViewCommandColumn>
                        <dx:GridViewCommandColumn VisibleIndex="6" ButtonType="Image" Width="50px" Caption="Удалить">
                            <CustomButtons>
                                <dx:GridViewCommandColumnCustomButton ID="cbDelete">
                                    <Image ToolTip="Удалить" Url="../../Content/Images/Icons/delete.png" />
                                </dx:GridViewCommandColumnCustomButton>
                            </CustomButtons>
                            <CellStyle HorizontalAlign="Center">
                            </CellStyle>
                        </dx:GridViewCommandColumn>
                    </Columns>
                        <SettingsBehavior ColumnResizeMode="NextColumn" EnableRowHotTrack="True" />
                        <SettingsPager Visible="False">
                            <PageSizeItemSettings Items="10, 20, 50, 100" ShowAllItem="True">
                            </PageSizeItemSettings>
                        </SettingsPager>
                        <SettingsLoadingPanel Mode="Disabled" />
                        <SettingsCookies CookiesID="MalwareGrid" Enabled="True" StorePaging="False" />
                        <Styles>
                            <Header Font-Bold="True">
                            </Header>
                        </Styles>
                </dx:ASPxGridView>
            </ContentTemplate>
            <Triggers>
                <asp:AsyncPostBackTrigger ControlID="gridViewMalware" EventName="DataBinding" />
            </Triggers>
        </asp:UpdatePanel>
    </div>
</asp:Content>
